<template>
  <div
    class="min-h-screen flex items-center justify-center p-6 relative overflow-hidden bg-slate-50"
  >
    <!-- Decorative background elements -->
    <div
      class="absolute top-[-10%] left-[-5%] w-[40%] h-[40%] bg-brand-green/10 rounded-full blur-[100px] animate-pulse"
    ></div>
    <div
      class="absolute bottom-[-10%] right-[-5%] w-[40%] h-[40%] bg-brand-blue/10 rounded-full blur-[100px] animate-pulse"
      style="animation-delay: 2s"
    ></div>

    <div class="w-full max-w-2xl relative z-10 space-y-8">
      <!-- Logo / Back Link -->
      <div class="text-center space-y-4">
        <NuxtLink to="/" class="inline-flex items-center gap-2 group">
          <div
            class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-cartoon-sm border-2 border-slate-100 group-hover:scale-110 transition-transform"
          >
            <img src="~/assets/logo.png" alt="Zmeyka" class="w-6 h-6 object-contain" />
          </div>
          <span class="text-xl font-black text-slate-800 tracking-tighter">Zmeyka</span>
        </NuxtLink>
      </div>

      <!-- Step 1: Role Selection -->
      <div v-if="step === 1" class="space-y-10 animate-in fade-in zoom-in duration-500">
        <div class="text-center space-y-4">
          <h1 class="text-4xl md:text-5xl font-black text-slate-800 tracking-tight">
            –í—ã–±–µ—Ä–∏ —Å–≤–æ–π –ø—É—Ç—å üó∫Ô∏è
          </h1>
          <p class="text-slate-400 font-bold text-lg">–ö—Ç–æ —Ç—ã –≤ –º–∏—Ä–µ Zmeyka?</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <!-- Student Card -->
          <button
            @click="selectRole('STUDENT')"
            class="group bg-white p-10 rounded-[3rem] border-4 border-slate-100 shadow-cartoon hover:border-brand-green hover:translate-y-[-8px] transition-all text-left space-y-6 relative overflow-hidden"
          >
            <div
              class="w-20 h-20 bg-brand-green/10 rounded-3xl flex items-center justify-center text-5xl group-hover:scale-110 transition-transform"
            >
              üêç
            </div>
            <div class="space-y-2">
              <h3 class="text-2xl font-black text-slate-800">–£—á–µ–Ω–∏–∫</h3>
              <p class="font-bold text-slate-400 leading-snug">
                –•–æ—á—É —É—á–∏—Ç—å—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é, —Å–¥–∞–≤–∞—Ç—å –î–ó –∏ –ø–æ–ª—É—á–∞—Ç—å –º–µ–¥–∞–ª–∏.
              </p>
            </div>
            <div
              class="pt-4 flex items-center gap-2 text-brand-green font-black uppercase tracking-widest text-xs"
            >
              –ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ ‚Üí
            </div>
            <div
              class="absolute -right-8 -bottom-8 w-32 h-32 bg-brand-green/5 rounded-full group-hover:scale-150 transition-transform"
            ></div>
          </button>

          <!-- Teacher Card -->
          <button
            @click="selectRole('TEACHER')"
            class="group bg-white p-10 rounded-[3rem] border-4 border-slate-100 shadow-cartoon hover:border-brand-blue hover:translate-y-[-8px] transition-all text-left space-y-6 relative overflow-hidden"
          >
            <div
              class="w-20 h-20 bg-brand-blue/10 rounded-3xl flex items-center justify-center text-5xl group-hover:scale-110 transition-transform"
            >
              üë®‚Äçüè´
            </div>
            <div class="space-y-2">
              <h3 class="text-2xl font-black text-slate-800">–£—á–∏—Ç–µ–ª—å</h3>
              <p class="font-bold text-slate-400 leading-snug">
                –•–æ—á—É —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫—É—Ä—Å—ã, –¥–µ–ª–∏—Ç—å—Å—è –∑–Ω–∞–Ω–∏—è–º–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–±–æ—Ç—ã.
              </p>
            </div>
            <div
              class="pt-4 flex items-center gap-2 text-brand-blue font-black uppercase tracking-widest text-xs"
            >
              –°—Ç–∞—Ç—å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–æ–º ‚Üí
            </div>
            <div
              class="absolute -right-8 -bottom-8 w-32 h-32 bg-brand-blue/5 rounded-full group-hover:scale-150 transition-transform"
            ></div>
          </button>
        </div>
      </div>

      <!-- Step 2: Form Details -->
      <div
        v-if="step === 2"
        class="max-w-lg mx-auto animate-in slide-in-from-right-10 fade-in duration-500"
      >
        <div class="text-center space-y-4 mb-8">
          <button
            @click="step = 1"
            class="text-xs font-black text-slate-400 uppercase tracking-widest hover:text-slate-600 flex items-center justify-center gap-2 mx-auto"
          >
            ‚Üê –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É
          </button>
          <h1 class="text-4xl font-black text-slate-800 tracking-tight">–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ! ‚ú®</h1>
          <p class="text-slate-400 font-bold">–û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç—å —Ç–≤–æ–π —à–∏—Ñ—Ä</p>
        </div>

        <div
          class="bg-white p-10 rounded-[3rem] border-4 border-slate-100 shadow-cartoon space-y-8"
        >
          <form @submit.prevent="handleRegister" class="space-y-6">
            <!-- Full Name -->
            <div class="space-y-2">
              <label class="text-sm font-black text-slate-400 uppercase tracking-widest px-1"
                >–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?</label
              >
              <div class="relative group">
                <input
                  v-model="form.name"
                  type="text"
                  placeholder="–¢–≤–æ—ë –∏–º—è"
                  required
                  class="w-full px-6 py-5 bg-slate-50 border-4 border-slate-50 rounded-2xl font-bold text-slate-700 outline-none focus:border-brand-yellow focus:bg-white transition-all placeholder:text-slate-300"
                />
                <span
                  class="absolute right-6 top-1/2 -translate-y-1/2 text-2xl grayscale group-focus-within:grayscale-0 transition-all"
                  >üëã</span
                >
              </div>
            </div>

            <!-- Email -->
            <div class="space-y-2">
              <label class="text-sm font-black text-slate-400 uppercase tracking-widest px-1"
                >Email</label
              >
              <div class="relative group">
                <input
                  v-model="form.email"
                  type="email"
                  placeholder="serpent@expert.io"
                  required
                  class="w-full px-6 py-5 bg-slate-50 border-4 border-slate-50 rounded-2xl font-bold text-slate-700 outline-none focus:border-brand-green focus:bg-white transition-all placeholder:text-slate-300"
                />
                <span
                  class="absolute right-6 top-1/2 -translate-y-1/2 text-2xl grayscale group-focus-within:grayscale-0 transition-all"
                  >üìß</span
                >
              </div>
            </div>

            <!-- Password -->
            <div class="space-y-2">
              <label class="text-sm font-black text-slate-400 uppercase tracking-widest px-1"
                >–ü—Ä–∏–¥—É–º–∞–π —à–∏—Ñ—Ä</label
              >
              <div class="relative group">
                <input
                  v-model="form.password"
                  type="password"
                  placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"
                  required
                  class="w-full px-6 py-5 bg-slate-50 border-4 border-slate-50 rounded-2xl font-bold text-slate-700 outline-none focus:border-brand-blue focus:bg-white transition-all placeholder:text-slate-300"
                />
                <span
                  class="absolute right-6 top-1/2 -translate-y-1/2 text-2xl grayscale group-focus-within:grayscale-0 transition-all"
                  >üîë</span
                >
              </div>
            </div>

            <div
              v-if="error"
              class="p-4 bg-red-50 border-2 border-red-100 rounded-2xl text-red-500 font-bold text-sm flex items-center gap-3"
            >
              <span class="text-xl">‚ö†Ô∏è</span> {{ error }}
            </div>

            <button
              type="submit"
              :disabled="loading"
              class="w-full bg-brand-yellow py-5 rounded-2xl font-black text-slate-800 text-xl shadow-[0_8px_0_0_#ca8a04] hover:translate-y-0.5 hover:shadow-[0_6px_0_0_#ca8a04] active:translate-y-2 active:shadow-none transition-all disabled:opacity-50 flex items-center justify-center gap-3"
            >
              <span v-if="loading" class="animate-spin text-2xl">‚è≥</span>
              <span v-else>–í—ã–ª—É–ø–∏—Ç—å—Å—è –≤ IT</span>
            </button>
          </form>
        </div>
      </div>

      <p class="text-center font-bold text-slate-500">
        –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?
        <NuxtLink
          to="/login"
          class="text-brand-blue underline decoration-4 underline-offset-4 hover:text-brand-blue/80 transition-colors"
          >–ó–∞–ø–æ–ª–∑—Ç–∏ –æ–±—Ä–∞—Ç–Ω–æ</NuxtLink
        >
      </p>
    </div>
  </div>
</template>

<script setup lang="ts">
import { useUserStore } from '~/entities/user/model/store'
import { useAuthApi } from '~/features/auth/api'

const router = useRouter()
const userStore = useUserStore()
const { register } = useAuthApi()

const step = ref(1)
const form = reactive({
  name: '',
  email: '',
  password: '',
  role: 'STUDENT',
})

const loading = ref(false)
const error = ref('')

const selectRole = (role: 'STUDENT' | 'TEACHER') => {
  form.role = role
  step.value = 2
}

const handleRegister = async () => {
  loading.value = true
  error.value = ''

  try {
    const response = await register(form)
    userStore.setUser(response.user, response.accessToken)
    router.push('/dashboard')
  } catch (err: unknown) {
    const errorData = err as { data?: { message?: string }; message?: string }
    error.value =
      errorData.data?.message || errorData.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥—É—é –ø–æ—á—Ç—É!'
  } finally {
    loading.value = false
  }
}

definePageMeta({
  layout: false,
  middleware: ['guest'],
})
</script>

<style scoped>
.shadow-cartoon {
  box-shadow: 0 15px 0 0 #f1f5f9;
}
.shadow-cartoon-sm {
  box-shadow: 0 8px 0 0 #f1f5f9;
}
input:focus {
  filter: drop-shadow(0 0 10px rgba(234, 179, 8, 0.1));
}
</style>
