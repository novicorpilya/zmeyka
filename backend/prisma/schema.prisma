generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}


enum Role {
  STUDENT
  TEACHER
  ADMIN
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  name          String?
  avatar        String?
  role          Role           @default(STUDENT)
  courses       Course[]       @relation("UserCourses")
  homeworks     Homework[]     @relation("UserHomeworks")
  comments      Comment[]      @relation("UserComments")
  progress      UserProgress[]
  stats         UserStats?
  activities    UserActivity[]
  refreshToken  String?
  resetToken         String?
  resetTokenExpires  DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([email])
}

model UserStats {
  id               String @id @default(uuid())
  user             User   @relation(fields: [userId], references: [id])
  userId           String @unique
  xp               Int    @default(0)
  level            Int    @default(1)
  streak           Int    @default(0)
  longestStreak    Int    @default(0)
  completedCourses Int    @default(0)
  completedLessons Int    @default(0)
  lastActivityAt   DateTime @default(now())
}

model UserProgress {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  lesson    Lesson   @relation(fields: [lessonId], references: [id])
  lessonId  String
  isCompleted Boolean @default(false)
  completedAt DateTime?
  updatedAt   DateTime @updatedAt

  @@unique([userId, lessonId])
  @@index([userId])
}

model UserActivity {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  date      DateTime @default(now()) // Stored as YYYY-MM-DD
  points    Int      @default(0)
  type      String   // LOGIN, LESSON_COMPLETED, HOMEWORK_SUBMITTED

  @@index([userId, date])
}

model Course {
  id           String        @id @default(uuid())
  title        String
  description  String?
  thumbnail    String?
  category     String?
  level        String?
  teacher      User          @relation("UserCourses", fields: [teacherId], references: [id])
  teacherId    String
  isPublished  Boolean       @default(false)

  modules      Module[]
  homeworks    Homework[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([teacherId])
  @@index([updatedAt])
}


model Module {
  id       String   @id @default(uuid())
  title    String
  order    Int
  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId String
  lessons  Lesson[]

  @@index([courseId, order])
}

model Lesson {
  id             String   @id @default(uuid())
  title          String
  content        String?   // Brief description
  contentRich    String?   // Markdown or JSON for conspectus
  conspectusFile String?   // URL to attached file (PDF/Doc)
  videoUrl       String?
  homeworkTitle  String?
  homeworkTask   String?   // The prompt for the student
  homeworkFile   String?   // URL to attached template (Zip/Code)
  order          Int
  module         Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  moduleId       String
  quiz           Quiz?
  homeworks      Homework[]
  progress       UserProgress[]

  @@index([moduleId, order])
}

model Quiz {
  id        String     @id @default(uuid())
  lesson    Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  lessonId  String     @unique
  questions Question[]
}

model Question {
  id            String @id @default(uuid())
  text          String
  options       String // JSON string representing array of options
  correctOption Int
  quiz          Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId        String

  @@index([quizId])
}

model Homework {
  id        String   @id @default(uuid())
  status    String   @default("PENDING") // PENDING, CHECKING, COMPLETED, REJECTED
  score     Int?
  feedback  String?
  
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  lessonId  String
  
  solutionText String?
  
  student   User     @relation("UserHomeworks", fields: [studentId], references: [id])
  studentId String

  course    Course   @relation(fields: [courseId], references: [id])
  courseId  String

  comments  Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([lessonId, studentId])
  @@index([lessonId])
  @@index([studentId])
  @@index([courseId])
  @@index([status])
}

model Comment {
  id         String   @id @default(uuid())
  text       String
  author     User     @relation("UserComments", fields: [authorId], references: [id])
  authorId   String
  homework   Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  homeworkId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([homeworkId])
  @@index([authorId])
}

